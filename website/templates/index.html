{% extends "graph.html" %}

{% block body %}
<div class="container">
  <div class="row">
    <div class="col-md-2">
      <p class="text-center">
        <select id="left-type">
          <option value="-">---</option>
{% for type in types %}
          <option value="{{ type.id }}">{{ type }}</option>
{% endfor %}
        </select>
      </p>
    </div>
    <div class="col-md-8 text-center">
      <div id="graphrange">
        <i class="fa fa-calendar fa-lg"></i>
        <span></span> <b class="caret"></b>
      </div>
    </div>
    <div class="col-md-2">
      <p class="text-center">
        <select id="right-type">
          <option value="-">---</option>
{% for type in types %}
          <option value="{{ type.id }}">{{ type }}</option>
{% endfor %}
        </select>
      </p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-2">
      <div id="left-legend"></div>
    </div>
    <div id="graph-container" class="col-md-8">
      <div id="left-axis"></div>
      <div id="chart"></div>
      <div id="right-axis"></div>
    </div>
    <div class="col-md-2">
      <div id="right-legend"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block script %}
<script>
  var startDate = moment().subtract('month', 1);
  var endDate = moment();

  function fetchMeasurements(type, callback) {
    if (type == "-")
      callback(null);

    var url = "{% url 'measurements' %}?type=" + type + "&mindate=" + startDate.unix() + "&maxdate=" + endDate.unix();
    $.getJSON(url, null, callback);
  }

  function updateGraph() {
    $('#chart').html('');
    $('#left-axis').html('');
    $('#left-legend').html('');
    $('#right-axis').html('');
    $('#right-legend').html('');
    $('#graphrange span').html(startDate.format('MMMM D, YYYY') + ' - ' + endDate.format('MMMM D, YYYY'));

    fetchMeasurements($('#left-type').val(), function(leftData) {
      fetchMeasurements($('#right-type').val(), function(rightData) {
        var palette = new Rickshaw.Color.Palette();

        var series = [];

        if (leftData) {
          leftMax = 0;
          for (var sensor of leftData) {
            for (var measurement of sensor.measurements)
              leftMax = Math.max(leftMax, measurement.value);
          }

          for (var sensor of leftData) {
            series.push({
              name: sensor.device.name,
              color: palette.color(),
              data: [{x: m.time, y: m.value / leftMax} for (m of sensor.measurements)]
            })
          }
        }

        if (rightData) {
          rightMax = 0;
          for (var sensor of rightData) {
            for (var measurement of sensor.measurements)
              leftMax = Math.max(rightMax, measurement.value);
          }

          for (var sensor of rightData) {
            series.push({
              name: sensor.device.name,
              color: palette.color(),
              data: [{x: m.time, y: m.value / rightMax} for (m of sensor.measurements)]
            })
          }
        }

        var graph = new Rickshaw.Graph({
          element: document.querySelector("#chart"),
          renderer: 'line',
          series: series,
          width: 700,
          height: 500
        });

        var x_axis = new Rickshaw.Graph.Axis.Time({
          graph: graph,
          ticksTreatment: "glow"
        });

        if (leftData) {
          var left_axis = new Rickshaw.Graph.Axis.Y({
            graph: graph,
            orientation: 'left',
            element: document.getElementById('left-axis'),
            tickFormat: function(v) { return (leftMax * v).toFixed(2); }
          });

          var left_legend = new Rickshaw.Graph.Legend({
            graph: graph,
            element: document.querySelector('#left-legend')
          });

          /*var shelving = new Rickshaw.Graph.Behavior.Series.Toggle({
            graph: graph,
            legend: left_legend
          });*/

          var highlighter = new Rickshaw.Graph.Behavior.Series.Highlight({
            graph: graph,
            legend: left_legend
          });
        }

        if (rightData) {
          var right_axis = new Rickshaw.Graph.Axis.Y({
            graph: graph,
            orientation: 'right',
            element: document.getElementById('right-axis'),
            tickFormat: function(v) { return (rightMax * v).toFixed(2); }
          });

          var right_legend = new Rickshaw.Graph.Legend({
            graph: graph,
            element: document.querySelector('#right-legend')
          });

          /*var shelving = new Rickshaw.Graph.Behavior.Series.Toggle({
            graph: graph,
            legend: right_legend
          });*/

          var highlighter = new Rickshaw.Graph.Behavior.Series.Highlight({
            graph: graph,
            legend: right_legend
          });
        }

        new Rickshaw.Graph.HoverDetail({
          graph: graph,
          xFormatter: function(x) {
            var date = moment.unix(x);
            return date.format('lll');
          },
          yFormatter: function(y) {
            return (parseFloat(y) * leftMax).toFixed(2);
          }
        });

        graph.render();
      });
    });
  }

  $('#graphrange').daterangepicker({
      ranges: {
        'Last Week': [moment().subtract('days', 6), moment()],
        'Last Month': [moment().subtract('month', 1), moment()],
        'Last Year': [moment().subtract('year', 1), moment()]
      },
      startDate: startDate,
      endDate: endDate,
      minDate: moment.unix({{ mindate|date:"U" }}),
      maxDate: moment.unix({{ maxdate|date:"U" }})
    },
    function(start, end) {
      startDate = start;
      endDate = end;

      updateGraph();
    }
  );

  $('#left-type').on('change', updateGraph);
  $('#right-type').on('change', updateGraph);

  updateGraph();
</script>
{% endblock %}
